
```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
library(dataRetrieval)
library(dplyr)
library(lubridate)
library(gsplot)

source("../R/functions-qwtimeseries.R")
```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height = 14, fig.width=11} 
wy_dates <- convertWYtoDate(wy)
wy_end <- wy_dates$wy_end

pcodes <- c("00665", "70953", "32210", "00078", "00098")

qw_historic <- readNWISqw(siteNumbers = siteNumber, 
                          parameterCd = pcodes,
                          startDate = "1800-01-01", 
                          endDat = wy_end)

isGreenLake <- siteNumber %in% c('434756089020500', '434928088570000')
isData <- nrow(qw_historic)!=0

```

#`r if(!isData) {paste("No water quality data available for", siteNumber)}`#

```{r eval=isData, echo=FALSE, warning=FALSE, message=FALSE, fig.height = 14, fig.width=11}
depth <- filterParmData(qw_historic, "00098")
totalP <- filterParmData(qw_historic, "00665", isTotalP = TRUE, depth) 
chlorophyll <- filterParmData(qw_historic, c("32210", "70953"), depth)
secchi <- filterParmData(qw_historic, "00078", depth)
trophic <- calcTrophicIndex(totalP, secchi, chlorophyll)

# getting correct dates for labels/axis ticks
all_dates <- year(c(totalP$sample_dt, chlorophyll$sample_dt, secchi$sample_dt, trophic$sample_dt))
firstDate <- as.Date(paste0(min(all_dates), "-01-01"))
lastDate <- as.Date(format(wy_dates$wy_end, "%Y-12-31"))
yrs <- seq(firstDate, lastDate, by = "years")
date_info <- list(firstDate = firstDate, lastDate = lastDate, yrs = yrs)

totalP_title <- "TOTAL PHOSPHORUS CONCENTRATION\nIN MILLIGRAMS PER LITER"
chlorophyll_title <- "CHLOROPHYLL CONCENTRATION\nIN MICROGRAMS PER LITER"
secchi_title <- "SECCHI DEPTH, IN METERS"
trophic_title <- "TROPHIC STATE INDEX"

par(oma = c(1,4,4,0) + 0.1,
    mar = c(2,2,4,0) + 0.1)

plot_layout <- matrix(1:4, 4, 1)
layout(plot_layout)
makeTimeseriesPlot(totalP, totalP_title, date_info, isGreenLake, ylim_buffer = 0.05)
makeTimeseriesPlot(chlorophyll, chlorophyll_title, date_info, isGreenLake, ylim_buffer = 1)
makeTimeseriesPlot(secchi, secchi_title, date_info, isGreenLake, isSecchi = TRUE, 
                   axisFlip = TRUE, ylim_buffer = 0.5)
makeTimeseriesPlot(trophic, trophic_title, date_info, isGreenLake, isTrophicIndex = TRUE)
```

